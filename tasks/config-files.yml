---
- name: Replace system-wide containers.conf
  template:
    src: containers.conf.j2
    dest: /usr/share/containers/containers.conf
    owner: root
    group: root
    mode: '0644'

- name: Create directory for storing container volumes and images
  ansible.builtin.file:
    path: "{{ container_storage }}"
    state: directory
    owner: "{{ podman_user }}"
    group: "{{ podman_group }}"
    mode: '0700'

- name: Get user home - getent
  ansible.builtin.getent:
    database: passwd
    key: "{{ podman_user }}"

- name: Get user home - set_fact
  ansible.builtin.set_fact:
    podman_user_home: "{{ getent_passwd[username][4] }}"

- name: Get user home - verify
  ansible.builtin.debug:
    msg: "User's home: {{ podman_user_home }}"

- name: Create user-specific storage.conf
  template:
    src: storage.conf.j2
    dest: "{{ podman_user_home }}/.config/containers/storage.conf"
    owner: "{{ podman_user}}"
    group: "{{ podman_group}}"
    mode: '0700'
